name: Create Release PR

on:
  workflow_dispatch

permissions:
  contents: write
  pull-requests: write


jobs:
  cdk_deploy:
    runs-on: ubuntu-latest

    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    # see https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
    permissions:
      id-token: write
      contents: read

    environment:
      name: ${{ github.ref_name }}

    env:
      AWS_CDK_STACKS: null
      AWS_CDK_STACKS_IGNORE_DEPENDENCY: false
      AWS_CDK_STACKS_EXPRESSION: --all
      AWS_OIDC_ROLE_ARN: testarn
      AWS_REGION: testregion
      ENVIRONMENT_MODE: testmode
      ENVIRONMENT_ID: testid
      NODE_VERSION: '18.17.1'
      PNPM_VERSION: '8.6.12'

    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          # TODO: Separate the account used for checking out the submodules
          # once we have a less privileged account
          # ssh-key: ${{ secrets.SUBMODULE_SYNC_SSH_KEY }}

      - uses: pnpm/action-setup@v2
        with:
          version: ${{env.PNPM_VERSION}}
          run_install: false

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: ${{env.NODE_VERSION}}
          cache: 'pnpm'

      - name: CDK Deploy
        working-directory: ./cdk
        run: |
          npx cdk deploy --require-approval never --context environmentMode=${{env.ENVIRONMENT_MODE}} --context environmentId=${{ env.environment_id }} ${{ env.AWS_CDK_STACKS_IGNORE_DEPENDENCY && '--exclusively' || '' }} $AWS_CDK_STACKS_EXPRESSION